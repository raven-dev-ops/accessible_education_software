const express = require('express');\nconst { Connector } = require('@google-cloud/cloud-sql-connector');\nconst { Pool } = require('pg');\n\nconst PORT = process.env.PORT || 8080;\nconst API_KEY = process.env.API_KEY;\nconst INSTANCE_CONNECTION_NAME = process.env.INSTANCE_CONNECTION_NAME; // e.g. cs-poc-kvjwpp97kjozemn894cmvvg:us-central1:accessible-software-db\nconst DB_USER = process.env.DB_USER || 'appuser';\nconst DB_PASS = process.env.DB_PASS;\nconst DB_NAME = process.env.DB_NAME || 'appdb';\n\nif (!API_KEY) {\n  console.warn('WARNING: API_KEY is not set. Set API_KEY to protect the Cloud Run endpoint.');\n}\n\nif (!INSTANCE_CONNECTION_NAME) {\n  console.warn('WARNING: INSTANCE_CONNECTION_NAME is not set. Set it to your Cloud SQL instance connection name.');\n}\n\nconst app = express();\napp.use(express.json());\n\n// Simple API key guard\napp.use((req, res, next) => {\n  if (!API_KEY) return res.status(500).json({ error: 'API_KEY is not configured' });\n  const key = req.headers['x-api-key'];\n  if (key !== API_KEY) {\n    return res.status(401).json({ error: 'Unauthorized' });\n  }\n  return next();\n});\n\nlet pool;\n\nasync function initPool() {\n  const connector = new Connector();\n  const clientOpts = await connector.getOptions({\n    instanceConnectionName: INSTANCE_CONNECTION_NAME,\n    ipType: 'PRIVATE',\n  });\n\n  pool = new Pool({\n    ...clientOpts,\n    user: DB_USER,\n    password: DB_PASS,\n    database: DB_NAME,\n    // The connector provides an SSL config when needed.\n    ssl: clientOpts.ssl,\n    max: 5,\n    idleTimeoutMillis: 30000,\n  });\n\n  pool.on('error', (err) => {\n    console.error('Unexpected error on idle client', err);\n  });\n}\n\napp.get('/health', (req, res) => {\n  return res.json({ ok: true, status: 'healthy' });\n});\n\napp.get('/db-ping', async (req, res) => {\n  try {\n    if (!pool) {\n      await initPool();\n    }\n    const result = await pool.query('SELECT current_user, now() as now');\n    return res.json({ ok: true, result: result.rows[0] });\n  } catch (error) {\n    console.error('DB ping failed', error);\n    return res.status(500).json({ ok: false, error: error.message });\n  }\n});\n\n// Placeholder profile read (you can adapt to your schema)\napp.get('/profile', async (req, res) => {\n  try {\n    if (!pool) {\n      await initPool();\n    }\n    // Replace with your own profile table/query.\n    const result = await pool.query('SELECT current_user');\n    return res.json({ ok: true, user: result.rows[0].current_user });\n  } catch (error) {\n    console.error('Profile fetch failed', error);\n    return res.status(500).json({ ok: false, error: error.message });\n  }\n});\n\napp.listen(PORT, () => {\n  console.log(Cloud Run API listening on port );\n});\n